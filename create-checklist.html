<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Create Work Checklist</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 14px;
}

h1 {
  margin: 0 0 6px;
}

.subtitle {
  font-size: 14px;
  color: #555;
  margin-bottom: 16px;
}

.card {
  background: #fff;
  border-radius: 8px;
  padding: 14px;
  margin-bottom: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

label {
  font-size: 14px;
  font-weight: bold;
  display: block;
  margin-bottom: 6px;
}

select {
  width: 100%;
  padding: 12px;
  font-size: 14px;
  border-radius: 6px;
  border: 1px solid #ccc;
}

/* ===== Preview styles ===== */
.preview-section {
  margin: 14px 0 8px;
  padding: 8px 10px;
  background: #f1f3f5;
  border-left: 4px solid #3498db;
  font-weight: bold;
  color: #2c3e50;
  border-radius: 4px;
}

.preview-item {
  padding: 8px 0 10px 10px;
  border-bottom: 1px solid #eee;
}

.preview-item:last-child {
  border-bottom: none;
}

.item-desc {
  font-size: 14px;
}

.item-meta {
  font-size: 12px;
  color: #777;
  margin-top: 2px;
}

/* ===== Buttons ===== */
.btn {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
}

.btn-primary {
  background: #2c3e50;
  color: #fff;
}

.btn-secondary {
  background: #7f8c8d;
  color: #fff;
  margin-top: 8px;
}
</style>
</head>

<body>

<h1>Create Checklist</h1>
<div class="subtitle">From Accepted Quotation</div>

<!-- ===== SELECT QUOTATION ===== -->
<div class="card">
  <label>Select Quotation</label>
  <select id="quotationSelect">
    <option value="">Loading...</option>
  </select>
</div>

<!-- ===== PREVIEW ===== 
<div class="card">
  <label>Checklist Preview</label>
  <div id="itemsBox" style="font-size:14px;color:#777;">
    Please select a quotation
  </div>
</div>-->

<!-- ===== ACTION ===== -->
<div class="card">
  <button class="btn btn-primary" onclick="createChecklist()">
    Create Checklist
  </button>
  <button class="btn btn-secondary" onclick="history.back()">
    Cancel
  </button>
</div>

<script>
/* ===== AUTH CHECK ===== */
fetch("/api/auth-check", { credentials: "include" })
  .then(r => r.json())
  .then(d => {
    if (!d.loggedIn) location.replace("/login.html");
    if (d.role !== "admin") location.replace("/work-checklist.html");
  });

const quotationSelect = document.getElementById("quotationSelect");
const itemsBox = document.getElementById("itemsBox");

/* ===== LOAD QUOTATIONS ===== */
fetch("/api/quotation-list-for-checklist", { credentials: "include" })
  .then(r => r.json())
  .then(list => {
    quotationSelect.innerHTML =
      `<option value="">-- Select quotation --</option>`;
    list.forEach(q => {
      const opt = document.createElement("option");
      opt.value = q.id;
      opt.textContent = `${q.quotation_no} - ${q.customer}`;
      quotationSelect.appendChild(opt);
    });
  });

/* ===== LOAD PREVIEW ===== */
quotationSelect.onchange = async () => {
  const id = quotationSelect.value;
  itemsBox.innerHTML = "Loading preview...";

  if (!id) {
    itemsBox.innerHTML = "Please select a quotation";
    return;
  }

  const res = await fetch(`/api/quotation-view?id=${id}`, {
    credentials: "include"
  });

  if (!res.ok) {
    itemsBox.innerHTML = "Failed to load quotation";
    return;
  }

  const data = await res.json();
  const sections = data.sections || [];
  const items = data.items || [];

  itemsBox.innerHTML = "";

  /* ===== CASE 1: 有 section ===== */
  if (sections.length) {
    sections.forEach(sec => {
      const secDiv = document.createElement("div");
      secDiv.className = "preview-section";
      secDiv.textContent = sec.section_title;
      itemsBox.appendChild(secDiv);

      items
        .filter(it => it.section_id === sec.id)
        .forEach(it => {
          const itemDiv = document.createElement("div");
          itemDiv.className = "preview-item";
          itemDiv.innerHTML = `
            <div class="item-desc">${it.description}</div>
            <div class="item-meta">Default status: NOT_STARTED</div>
          `;
          itemsBox.appendChild(itemDiv);
        });
    });
    return;
  }

  /* ===== CASE 2: 没 section，但有 items ===== */
  if (items.length) {
    items.forEach(it => {
      const itemDiv = document.createElement("div");
      itemDiv.className = "preview-item";
      itemDiv.innerHTML = `
        <div class="item-desc">${it.description}</div>
        <div class="item-meta">Default status: NOT_STARTED</div>
      `;
      itemsBox.appendChild(itemDiv);
    });
    return;
  }

  /* ===== CASE 3: 什么都没有 ===== */
  itemsBox.innerHTML = "No checklist items found";
};

/* ===== CREATE CHECKLIST ===== */
async function createChecklist() {
  const quotation_id = quotationSelect.value;
  if (!quotation_id) {
    alert("Please select a quotation");
    return;
  }

  if (!confirm("Create checklist from this quotation?")) return;

  const res = await fetch("/api/work-checklist-create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ quotation_id })
  });

  if (!res.ok) {
    alert("Failed to create checklist");
    return;
  }

  const data = await res.json();
  location.href = `/work-checklist-view.html?id=${data.work_checklist_id}`;
}
</script>

</body>
</html>
