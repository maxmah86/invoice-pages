<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create VO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 14px;
}

h2 {
  margin: 0 0 6px;
}

.subtitle {
  font-size: 14px;
  color: #555;
  margin-bottom: 14px;
}

.card {
  background: #fff;
  padding: 14px;
  border-radius: 8px;
  margin-bottom: 12px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

label {
  display: block;
  font-size: 14px;
  font-weight: bold;
  margin-top: 10px;
}

input, textarea {
  width: 100%;
  padding: 10px;
  font-size: 14px;
  margin-top: 6px;
  border-radius: 6px;
  border: 1px solid #ccc;
  box-sizing: border-box;
}

textarea {
  resize: vertical;
}

table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

th, td {
  border-bottom: 1px solid #ddd;
  padding: 6px;
}

th {
  background: #f0f0f0;
}

.right {
  text-align: right;
}

.btn {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  cursor: pointer;
  margin-top: 10px;
}

.btn-primary {
  background: #2c3e50;
  color: #fff;
}

.btn-add {
  background: #27ae60;
  color: #fff;
}

.btn-cancel {
  background: #7f8c8d;
  color: #fff;
}

.error {
  background: #fee;
  border: 1px solid #e74c3c;
  color: #c0392b;
  padding: 10px;
  border-radius: 6px;
  font-size: 13px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<h2>Create Variation Order</h2>
<div class="subtitle">MMAC Construction</div>

<div class="card">
  <label>Quotation ID (optional)</label>
  <input id="quotation_id" placeholder="Quotation ID">

  <label>Invoice ID (optional)</label>
  <input id="invoice_id" placeholder="Invoice ID">

  <label>Title</label>
  <input id="title" placeholder="VO title">

  <label>Reason</label>
  <textarea id="reason" rows="3"></textarea>
</div>

<div class="card">
  <label>Items</label>

  <table>
    <thead>
      <tr>
        <th>Description</th>
        <th width="60">Qty</th>
        <th width="90">Price</th>
        <th width="90">Amount</th>
      </tr>
    </thead>
    <tbody id="items"></tbody>
  </table>

  <button class="btn btn-add" onclick="addItem()">+ Add Item</button>
</div>

<div class="card">
  <div class="right">Total: RM <strong id="total">0.00</strong></div>
</div>

<div class="card">
  <label>Notes</label>
  <textarea id="notes" rows="3"></textarea>
</div>

<div class="card" id="errorBox" style="display:none;">
  <div class="error" id="errorText"></div>
</div>

<div class="card">
  <button class="btn btn-primary" onclick="submitVO()">Create VO</button>
  <button class="btn btn-cancel" onclick="history.back()">Cancel</button>
</div>

<script>
const tbody = document.getElementById("items");
const totalEl = document.getElementById("total");

function addItem() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input></td>
    <td><input type="number" value="1" min="1" onchange="calc()"></td>
    <td><input type="number" step="0.01" value="0" onchange="calc()"></td>
    <td class="right">0.00</td>
  `;
  tbody.appendChild(tr);
}

function calc() {
  let total = 0;
  [...tbody.rows].forEach(r => {
    const qty = Number(r.cells[1].children[0].value || 0);
    const price = Number(r.cells[2].children[0].value || 0);
    const amt = qty * price;
    r.cells[3].innerText = amt.toFixed(2);
    total += amt;
  });
  totalEl.innerText = total.toFixed(2);
}

addItem();

async function submitVO() {
  document.getElementById("errorBox").style.display = "none";

  const items = [...tbody.rows].map(r => ({
    description: r.cells[0].children[0].value,
    qty: r.cells[1].children[0].value,
    unit_price: r.cells[2].children[0].value
  })).filter(i => i.description);

  const payload = {
    quotation_id: quotation_id.value || null,
    invoice_id: invoice_id.value || null,
    title: title.value,
    reason: reason.value,
    notes: notes.value,
    items
  };

  try {
    const res = await fetch("/api/vo-create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      throw data;
    }

    alert("VO created");
    location.href = "/vos.html";

  } catch (e) {
    document.getElementById("errorBox").style.display = "block";
    document.getElementById("errorText").innerText = JSON.stringify(e, null, 2);
  }
}
</script>

</body>
</html>
