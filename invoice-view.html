<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Invoice</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root {
      --gap: 10px;
      --font: Arial, sans-serif;
      --border: #000;
      --muted-bg: #f0f0f0;
      --padding: 8px;
    }

    body {
      font-family: var(--font);
      margin: 16px;
      color: #000;
    }

    /* HEADER */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      gap: 16px;
      flex-wrap: wrap;
    }

    .company {
      font-size: 14px;
      line-height: 1.5;
      max-width: 60%;
    }

    .company-header {
      display: flex;
      align-items: flex-start;
      gap: var(--gap);
      margin-bottom: 8px;
    }

    .company-logo {
      width: 48px;
      height: auto;
      margin-top: 4px;
      flex-shrink: 0;
    }

    .company-text h1 {
      margin: 0;
      font-size: 26px;
      font-weight: bold;
    }

    .ssm-code {
      font-size: 14px;
      margin-top: 2px;
    }

    /* INVOICE BOX */
    .invoice-box {
      text-align: right;
      min-width: 240px;
    }

    .invoice-title {
      font-size: 26px;
      font-weight: bold;
    }

    .invoice-actions {
      margin: 6px 0;
    }

    .invoice-actions button {
      padding: 6px 12px;
      font-size: 13px;
      margin-left: 6px;
      cursor: pointer;
    }

    .invoice-meta {
      font-size: 14px;
      line-height: 1.6;
      text-align: right;
    }

    /* CONTENT */
    .section {
      margin-top: 20px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
    }

    th, td {
      border: 1px solid var(--border);
      padding: var(--padding);
      font-size: 13px;
    }

    th {
      background: var(--muted-bg);
    }

    .text-right {
      text-align: right;
    }

    .total {
      font-size: 16px;
      font-weight: bold;
      text-align: right;
      margin-top: 12px;
    }

    .footer {
      margin-top: 20px;
      font-size: 13px;
      line-height: 1.6;
    }

    /* Company Chop (右下角) */
    .company-chop {
      position: fixed;
      right: 30px;
      bottom: 40px;
      width: 120px;
      opacity: 0.85;
    }

    /* PRINT MODE */
    @media print {
      button {
        display: none !important;
      }
      .company-chop {
        position: absolute;
      }
    }

    /* Responsive tweaks */
    @media (max-width: 720px) {
      .company {
        max-width: 100%;
      }
      .invoice-box {
        text-align: left;
        width: 100%;
        margin-top: 12px;
      }
      .header {
        flex-direction: column;
        align-items: stretch;
      }
    }
  </style>
</head>

<body>
  <header class="header" role="banner">
    <div class="company" id="companyInfo">
      <div class="company-header">
        <img src="/icon-512.png" alt="MMAC Logo" class="company-logo" />
        <div class="company-text">
          <h1>MMAC CONSTRUCTION</h1>
          <div class="ssm-code">201903134488 (002977225-A)</div>
        </div>
      </div>

      <address>
        52, Jalan Mahogani SD 1/3<br />
        Sri Damansara<br />
        52200 Kuala Lumpur, Malaysia<br />
        Tel: 016-444-2128
      </address>
    </div>

    <div class="invoice-box" aria-labelledby="invoiceLabel">
      <div id="invoiceLabel" class="invoice-title">INVOICE</div>

      <div class="invoice-actions" id="actionButtons">
        <button id="printBtn" type="button">PRINT / SAVE PDF</button>
        <button id="editBtn" type="button">EDIT</button>
        <button id="voidBtn" type="button">VOID</button>
      </div>

      <div class="invoice-meta" id="invoiceMeta">
        <div><strong>Invoice No:</strong> <span id="invoiceNo">—</span></div>
        <div><strong>Date:</strong> <span id="invoiceDate">—</span></div>
        <div><strong>To:</strong> <span id="customer">—</span></div>
      </div>
    </div>
  </header>

  <main class="section" role="main">
    <table aria-describedby="itemsDesc">
      <caption id="itemsDesc" style="caption-side: top; text-align: left; font-weight: bold;">Items</caption>
      <thead>
        <tr>
          <th style="width:5%">No</th>
          <th>Description</th>
          <th style="width:10%">Qty</th>
          <th style="width:15%">Unit Price</th>
          <th style="width:15%">Amount (RM)</th>
        </tr>
      </thead>
      <tbody id="items" aria-live="polite"></tbody>
    </table>

    <div class="total">
      TOTAL (RM): <span id="total">0.00</span>
    </div>
  </main>

  <footer class="footer" role="contentinfo">
    <strong>ALL CHEQUES TO BE CROSSED AND MAKE PAYABLE TO THE ORDER OF</strong><br />
    MMAC CONSTRUCTION<br /><br />

    <strong>COMPANY ACCOUNT NUMBER:</strong><br />
    MAYBANK : 5142-0863-6636<br /><br />

    Thank you.
  </footer>

  <img src="/mmac-chop.png" alt="MMAC Company Chop" class="company-chop" />

  <script>
    (function () {
      // Utilities
      const qs = (sel) => document.querySelector(sel);
      const qid = (id) => document.getElementById(id);
      const formatCurrency = (value) => {
        try {
          return new Intl.NumberFormat('en-MY', {
            style: 'currency',
            currency: 'MYR',
            currencyDisplay: 'narrowSymbol',
            minimumFractionDigits: 2
          }).format(value);
        } catch {
          return 'RM ' + Number(value).toFixed(2);
        }
      };

      // Elements
      const printBtn = qid('printBtn');
      const editBtn = qid('editBtn');
      const voidBtn = qid('voidBtn');
      const invoiceNoEl = qid('invoiceNo');
      const invoiceDateEl = qid('invoiceDate');
      const customerEl = qid('customer');
      const itemsTbody = qid('items');
      const totalEl = qid('total');

      const params = new URLSearchParams(location.search);
      const id = params.get('id');
      if (!id) {
        // If no id provided, inform the user and stop further processing
        invoiceNoEl.textContent = 'N/A';
        invoiceDateEl.textContent = 'N/A';
        customerEl.textContent = 'N/A';
        itemsTbody.innerHTML = '<tr><td colspan="5">No invoice id provided.</td></tr>';
        printBtn.disabled = true;
        editBtn.disabled = true;
        voidBtn.disabled = true;
        return;
      }

      // Print handling with before/after hooks to restore title reliably
      const originalTitle = document.title;
      const setPrintTitle = () => { document.title = `invoice-${id}.pdf`; };
      const restoreTitle = () => { document.title = originalTitle; };

      // Some browsers support onbeforeprint/onafterprint
      window.onbeforeprint = setPrintTitle;
      window.onafterprint = restoreTitle;

      // Also handle as fallback
      printBtn.addEventListener('click', () => {
        setPrintTitle();
        // Use print(), then restore via afterprint or timeout fallback
        window.print();
        // Timeout fallback: restore after 1s if onafterprint not triggered
        setTimeout(restoreTitle, 1000);
      });

      editBtn.addEventListener('click', () => {
        location.href = `/invoice-edit.html?id=${encodeURIComponent(id)}`;
      });

      voidBtn.addEventListener('click', async () => {
        if (!confirm('Are you sure you want to VOID this invoice?')) return;
        voidBtn.disabled = true;
        try {
          const res = await fetch('/api/invoice-void', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            credentials: 'include',
            body: JSON.stringify({ id })
          });
          if (!res.ok) {
            const text = await res.text().catch(() => null);
            throw new Error(text || 'Server returned error');
          }
          alert('Invoice voided');
          location.reload();
        } catch (err) {
          console.error('Void error', err);
          alert('Failed to void invoice: ' + (err.message || 'Unknown error'));
          voidBtn.disabled = false;
        }
      });

      // Load invoice data
      (async function load() {
        try {
          const res = await fetch(`/api/invoice-view?id=${encodeURIComponent(id)}`, { credentials: 'include' });
          if (res.status === 401) {
            location.replace('/login.html');
            return;
          }
          if (!res.ok) {
            const text = await res.text().catch(() => null);
            throw new Error(text || `HTTP.status}`);
          }
          const data = await res.json();

          if (!data || !data.invoice) {
            throw new Error('Invoice not found');
          }

          // Populate header/meta
          invoiceNoEl.textContent = data.invoice.invoice_no ?? '—';

          // Parse date robustly: replace space with T to help browsers parse "YYYY-MM-DD HH:MM:SS"
          let createdAt = data.invoice.created_at || '';
          let dateDisplay = createdAt.split(' ')[0] || '—';
          try {
            const d = new Date(createdAt.replace(' ', 'T'));
            if (!isNaN(d)) {
              dateDisplay = d.toLocaleDateString();
            }
          } catch (e) {
            // keep fallback
          }
          invoiceDateEl.textContent = dateDisplay;

          customerEl.textContent = data.invoice.customer ?? '—';

          // Build items safely (avoid innerHTML)
          itemsTbody.innerHTML = '';
          let total = 0;
          if (Array.isArray(data.items) && data.items.length) {
            data.items.forEach((item, i) => {
              const qty = Number(item.qty) || 0;
              const price = Number(item.price) || 0;
              const amount = qty * price;
              total += amount;

              const tr = document.createElement('tr');

              const tdNo = document.createElement('td');
              tdNo.textContent = String(i + 1);
              tr.appendChild(tdNo);

              const tdDesc = document.createElement('td');
              tdDesc.textContent = item.description ?? '';
              tr.appendChild(tdDesc);

              const tdQty = document.createElement('td');
              tdQty.className = 'text-right';
              tdQty.textContent = qty.toString();
              tr.appendChild(tdQty);

              const tdPrice = document.createElement('td');
              tdPrice.className = 'text-right';
              tdPrice.textContent = formatCurrency(price);
              tr.appendChild(tdPrice);

              const tdAmount = document.createElement('td');
              tdAmount.className = 'text-right';
              tdAmount.textContent = formatCurrency(amount);
              tr.appendChild(tdAmount);

              itemsTbody.appendChild(tr);
            });
          } else {
            const tr = document.createElement('tr');
            const td = document.createElement('td');
            td.colSpan = 5;
            td.textContent = 'No items';
            tr.appendChild(td);
            itemsTbody.appendChild(tr);
          }

          totalEl.textContent = formatCurrency(total);
        } catch (err) {
          console.error(err);
          // Friendly UI fallback
          itemsTbody.innerHTML = '<tr><td colspan="5">Failed to load invoice data.</td></tr>';
          alert('Unable to load invoice: ' + (err.message || 'Unknown error'));
        }
      })();
    })();
  </script>
</body>
</html>