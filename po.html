<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create PO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  background: #f7f7f7;
}
h2 {
  text-align: center;
}
fieldset {
  border: 0;
  margin-bottom: 16px;
  padding: 0;
}
label {
  display: block;
  margin-bottom: 10px;
}
input, textarea, button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
  box-sizing: border-box;
}
textarea {
  resize: vertical;
}
.item {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.item button {
  background: #e74c3c;
  color: #fff;
  border: none;
  margin-top: 6px;
}
button.add {
  background: #3498db;
  color: #fff;
  border: none;
}
button.save {
  background: #27ae60;
  color: #fff;
  border: none;
  margin-top: 10px;
}
.summary {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
}
</style>
</head>

<body>

<h2>Create Purchase Order</h2>

<form id="poForm">

<fieldset>
  <label>PO No
    <input name="po_no" required>
  </label>

  <label>PO Date
    <input type="date" name="po_date" required>
  </label>

  <label>Supplier Name
    <input name="supplier_name" required>
  </label>

  <label>Supplier Address
    <textarea name="supplier_address" rows="3"></textarea>
  </label>
</fieldset>

<h3>Items</h3>
<div id="items"></div>

<button type="button" class="add" onclick="addItem()">+ Add Item</button>

<div class="summary">
  <label>Subtotal
    <input id="subtotal" readonly>
  </label>
  <label>Total
    <input id="total" readonly>
  </label>
</div>

<button type="submit" class="save">Save PO</button>
<a href="pos.html">Cancel</a>

</form>

<!-- LOGIN REQUIRE -->
<script>
(async () => {
  try {
    const r = await fetch("/api/auth-check");
    if (!r.ok) location.href = "login.html";
  } catch {
    location.href = "login.html";
  }
})();
</script>

<script>
const itemsDiv = document.getElementById("items");

function addItem() {
  const div = document.createElement("div");
  div.className = "item";
  div.innerHTML = `
    <label>Description
      <input class="desc" required>
    </label>
    <label>Qty
      <input type="number" class="qty" value="1" step="0.01">
    </label>
    <label>Unit Price
      <input type="number" class="price" value="0" step="0.01">
    </label>
    <label>Amount
      <input class="amount" readonly>
    </label>
    <button type="button" onclick="this.parentElement.remove(); calc()">Remove</button>
  `;
  itemsDiv.appendChild(div);
  calc();
}

function calc() {
  let total = 0;
  document.querySelectorAll(".item").forEach(i => {
    const q = +i.querySelector(".qty").value || 0;
    const p = +i.querySelector(".price").value || 0;
    const a = q * p;
    i.querySelector(".amount").value = a.toFixed(2);
    total += a;
  });
  subtotal.value = total.toFixed(2);
  total.value = total.toFixed(2);
}

itemsDiv.addEventListener("input", calc);
addItem();

poForm.onsubmit = async e => {
  e.preventDefault();

  const items = [];
  document.querySelectorAll(".item").forEach(i => {
    items.push({
      description: i.querySelector(".desc").value,
      qty: i.querySelector(".qty").value,
      unit_price: i.querySelector(".price").value,
      line_total: i.querySelector(".amount").value
    });
  });

  const data = {
    po_no: poForm.po_no.value,
    po_date: poForm.po_date.value,
    supplier_name: poForm.supplier_name.value,
    supplier_address: poForm.supplier_address.value,
    subtotal: subtotal.value,
    total: total.value,
    items
  };

  const r = await fetch("/api/po-create", {
    method: "POST",
    headers: {"Content-Type":"application/json"},
    body: JSON.stringify(data)
  });

  if (r.ok) {
    alert("PO Created");
    location.href = "pos.html";
  } else {
    alert("Failed");
  }
};
</script>

</body>
</html>
