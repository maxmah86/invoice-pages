<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Create Purchase Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  margin: 16px;
  color: #000;
}

h1 {
  margin-bottom: 12px;
}

/* ===== Form ===== */
.form-group {
  margin-bottom: 14px;
}

label {
  display: block;
  font-size: 14px;
  font-weight: bold;
  margin-bottom: 4px;
}

input, textarea {
  width: 100%;
  box-sizing: border-box;
  padding: 6px;
  font-size: 14px;
}

textarea {
  min-height: 60px;
}

/* ===== Items ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 10px;
}

th, td {
  border: 1px solid #000;
  padding: 6px;
  font-size: 13px;
}

th {
  background: #f0f0f0;
}

.text-right {
  text-align: right;
}

/* ===== Buttons ===== */
button {
  padding: 8px 14px;
  font-size: 14px;
  margin-top: 10px;
  cursor: pointer;
}

.total {
  font-size: 16px;
  font-weight: bold;
  text-align: right;
  margin-top: 10px;
}

/* ===== Error Box ===== */
#errorBox {
  display: none;
  margin-top: 16px;
  padding: 10px;
  border: 1px solid #c00;
  background: #fff3f3;
  font-size: 13px;
  white-space: pre-wrap;
}
</style>
</head>

<body>

<h1>Create Purchase Order</h1>

<!-- ===== BASIC INFO ===== -->
<div class="form-group">
  <label>Supplier Name *</label>
  <input id="supplier_name" placeholder="Required">
</div>

<div class="form-group">
  <label>PO Date</label>
  <input type="date" id="po_date">
</div>

<div class="form-group">
  <label>Issued By</label>
  <input id="issued_by" placeholder="Leave empty to use login user">
</div>

<div class="form-group">
  <label>Delivery Address</label>
  <textarea id="delivery_address"></textarea>
</div>

<div class="form-group">
  <label>Delivery Date</label>
  <input type="date" id="delivery_date">
</div>

<div class="form-group">
  <label>Delivery Time</label>
  <input id="delivery_time">
</div>

<div class="form-group">
  <label>Notes</label>
  <textarea id="notes"></textarea>
</div>

<!-- ===== ITEMS ===== -->
<h3>Items *</h3>

<table>
  <thead>
    <tr>
      <th style="width:5%">No</th>
      <th>Description</th>
      <th style="width:10%">Qty</th>
      <th style="width:15%">Unit Price</th>
      <th style="width:15%">Amount (RM)</th>
      <th style="width:5%"></th>
    </tr>
  </thead>
  <tbody id="items"></tbody>
</table>

<button onclick="addRow()">+ Add Item</button>

<div class="total">
  TOTAL (RM): <span id="total">0.00</span>
</div>

<br>

<button onclick="submitPO()">Create PO</button>
<button onclick="history.back()">Cancel</button>

<!-- ===== ERROR OUTPUT ===== -->
<div id="errorBox"></div>

<script>
function addRow(item = {}) {
  const tbody = document.getElementById("items");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td></td>
    <td><input class="desc" value="${item.description || ""}"></td>
    <td><input type="number" class="qty text-right" value="${item.qty || 0}" oninput="calc()"></td>
    <td><input type="number" class="price text-right" value="${item.price || 0}" oninput="calc()"></td>
    <td class="text-right amount">0.00</td>
    <td><button onclick="this.closest('tr').remove(); calc()">X</button></td>
  `;

  tbody.appendChild(tr);
  calc();
}

function calc() {
  let total = 0;
  document.querySelectorAll("#items tr").forEach((tr, i) => {
    tr.children[0].textContent = i + 1;

    const qty = Number(tr.querySelector(".qty").value) || 0;
    const price = Number(tr.querySelector(".price").value) || 0;
    const amount = qty * price;

    tr.querySelector(".amount").textContent = amount.toFixed(2);
    total += amount;
  });

  document.getElementById("total").textContent = total.toFixed(2);
}

async function submitPO() {
  const errorBox = document.getElementById("errorBox");
  errorBox.style.display = "none";
  errorBox.textContent = "";

  const items = [];
  document.querySelectorAll("#items tr").forEach(tr => {
    items.push({
      description: tr.querySelector(".desc").value,
      qty: Number(tr.querySelector(".qty").value) || 0,
      price: Number(tr.querySelector(".price").value) || 0
    });
  });

  if (!document.getElementById("supplier_name").value) {
    alert("Supplier Name is required");
    return;
  }

  if (items.length === 0) {
    alert("Please add at least one item");
    return;
  }

  const payload = {
    supplier_name: document.getElementById("supplier_name").value,
    po_date: document.getElementById("po_date").value,
    issued_by: document.getElementById("issued_by").value,
    delivery_address: document.getElementById("delivery_address").value,
    delivery_date: document.getElementById("delivery_date").value,
    delivery_time: document.getElementById("delivery_time").value,
    notes: document.getElementById("notes").value,
    items
  };

  try {
    const res = await fetch("/api/po-create", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload)
    });

    const text = await res.text();

    if (!res.ok) {
      errorBox.style.display = "block";
      errorBox.textContent =
        "Create PO failed (HTTP " + res.status + ")\n\n" + text;
      return;
    }

    alert("PO created successfully");
    location.href = "/pos.html";

  } catch (err) {
    errorBox.style.display = "block";
    errorBox.textContent = "Network / JS error:\n" + err.message;
  }
}

/* Init */
addRow();
</script>

</body>
</html>
