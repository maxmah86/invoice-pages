<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create PO</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 12px;
  background: #f6f6f6;
}
h2 {
  text-align: center;
}
label {
  display: block;
  margin-bottom: 10px;
}
input, textarea, button {
  width: 100%;
  padding: 12px;
  font-size: 16px;
}
textarea { resize: vertical; }
.item {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 10px;
}
.item button {
  background: #e74c3c;
  color: #fff;
  border: none;
}
button.add {
  background: #3498db;
  color: #fff;
  border: none;
  margin-bottom: 10px;
}
button.save {
  background: #27ae60;
  color: #fff;
  border: none;
}
.summary {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-top: 10px;
}
</style>
</head>

<body>

<h2>Create Purchase Order</h2>

<form id="poForm">

<!-- Supplier Info -->
<label>Supplier Name
  <input name="supplier_name" required>
</label>

<label>Supplier Address
  <textarea name="supplier_address" rows="3"></textarea>
</label>

<h3>Items</h3>
<div id="items"></div>

<button type="button" class="add" onclick="addItem()">+ Add Item</button>

<div class="summary">
  <label>Subtotal
    <input id="subtotal" readonly>
  </label>
  <label>Total
    <input id="total" readonly>
  </label>
</div>

<button type="submit" class="save">Save PO</button>
<a href="pos.html">Cancel</a>

</form>

<!-- LOGIN REQUIRE -->
<script>
(async () => {
  try {
    const r = await fetch("/api/auth-check");
    if (!r.ok) location.href = "login.html";
  } catch {
    location.href = "login.html";
  }
})();
</script>

<script>
const itemsDiv = document.getElementById("items");

function addItem() {
  const d = document.createElement("div");
  d.className = "item";
  d.innerHTML = `
    <label>Description
      <input class="desc" required>
    </label>
    <label>Qty
      <input type="number" class="qty" value="1" step="0.01">
    </label>
    <label>Unit Price
      <input type="number" class="price" value="0" step="0.01">
    </label>
    <label>Amount
      <input class="amount" readonly>
    </label>
    <button type="button" onclick="this.parentElement.remove(); calc()">Remove</button>
  `;
  itemsDiv.appendChild(d);
  calc();
}

function calc() {
  let sum = 0;
  document.querySelectorAll(".item").forEach(i => {
    const q = +i.querySelector(".qty").value || 0;
    const p = +i.querySelector(".price").value || 0;
    const a = q * p;
    i.querySelector(".amount").value = a.toFixed(2);
    sum += a;
  });
  subtotal.value = sum.toFixed(2);
  total.value = sum.toFixed(2);
}

itemsDiv.addEventListener("input", calc);
addItem();

poForm.onsubmit = async e => {
  e.preventDefault();

  const items = [];
  document.querySelectorAll(".item").forEach(i => {
    items.push({
      description: i.querySelector(".desc").value,
      qty: i.querySelector(".qty").value,
      unit_price: i.querySelector(".price").value,
      line_total: i.querySelector(".amount").value
    });
  });

  const payload = {
    supplier_name: poForm.supplier_name.value,
    supplier_address: poForm.supplier_address.value,
    subtotal: subtotal.value,
    total: total.value,
    items
  };

  const r = await fetch("/api/po-create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (r.ok) {
    alert("PO Created");
    location.href = "pos.html";
  } else {
    alert("Failed to create PO");
  }
};
</script>

</body>
</html>
