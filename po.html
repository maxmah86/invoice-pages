<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Create Purchase Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 16px;
}

h1 { margin: 0 0 6px; }
.subtitle { font-size:14px;color:#555;margin-bottom:16px; }

.card {
  background:#fff;
  padding:16px;
  border-radius:8px;
  margin-bottom:14px;
  box-shadow:0 1px 4px rgba(0,0,0,0.08);
}

label {
  display:block;
  margin-top:12px;
  margin-bottom:4px;
  font-size:14px;
  font-weight:bold;
}

input, textarea {
  width:100%;
  padding:10px;
  font-size:14px;
  border-radius:6px;
  border:1px solid #ccc;
  box-sizing:border-box;
}

textarea { resize:vertical; }

table {
  width:100%;
  border-collapse:collapse;
  font-size:14px;
}

th, td {
  border-bottom:1px solid #ddd;
  padding:6px;
  text-align:left;
}

th { background:#f0f0f0; }

.btn {
  width:100%;
  padding:12px;
  font-size:16px;
  border-radius:6px;
  border:none;
  cursor:pointer;
  margin-top:10px;
}

.btn-primary { background:#2c3e50;color:#fff; }
.btn-secondary { background:#7f8c8d;color:#fff; }
.btn-add { background:#27ae60;color:#fff;margin-top:10px; }

.right { text-align:right; }

.errorBox {
  background:#fee;
  border:1px solid #e74c3c;
  color:#c0392b;
  padding:10px;
  border-radius:6px;
  font-size:13px;
  white-space:pre-wrap;
}
</style>
</head>

<body>

<h1>Create Purchase Order</h1>
<div class="subtitle">MMAC Construction</div>

<!-- ===== BASIC INFO ===== -->
<div class="card">
  <label>Supplier Name *</label>
  <input id="supplier_name" placeholder="Supplier name">

  <label>Issued By</label>
  <input id="issued_by" value="MMAC SYSTEM">
</div>

<!-- ===== DELIVERY INFO ===== -->
<div class="card">
  <label>Delivery Address</label>
  <textarea id="delivery_address" rows="3"></textarea>

  <label>Delivery Date</label>
  <input type="date" id="delivery_date">

  <label>Delivery Time</label>
  <input type="time" id="delivery_time">
</div>

<!-- ===== ITEMS ===== -->
<div class="card">
  <label>Items</label>

  <table id="itemsTable">
    <thead>
      <tr>
        <th>Description</th>
        <th width="60">Qty</th>
        <th width="90">Price</th>
        <th width="90">Amount</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <button class="btn btn-add" onclick="addItem()">+ Add Item</button>
</div>

<!-- ===== TOTAL ===== -->
<div class="card">
  <div class="right">Subtotal: RM <span id="subtotal">0.00</span></div>
  <div class="right"><strong>Total: RM <span id="total">0.00</span></strong></div>
</div>

<!-- ===== NOTES ===== -->
<div class="card">
  <label>Notes</label>
  <textarea id="notes" rows="3">
Please supply the above items/services as per stated quantities and prices.
  </textarea>
</div>

<!-- ===== ERROR ===== -->
<div class="card" id="errorCard" style="display:none;">
  <div class="errorBox" id="errorBox"></div>
</div>

<!-- ===== ACTION ===== -->
<div class="card">
  <button class="btn btn-primary" onclick="submitPO()">Create PO</button>
  <button class="btn btn-secondary" onclick="history.back()">Cancel</button>
</div>

<script>
fetch("/api/auth-check",{credentials:"include"})
  .then(r=>r.json())
  .then(d=>{ if(!d.loggedIn) location.replace("/login.html"); })
  .catch(()=>location.replace("/login.html"));

const tbody = document.querySelector("#itemsTable tbody");
const subtotalEl = document.getElementById("subtotal");
const totalEl = document.getElementById("total");

function addItem() {
  const tr = document.createElement("tr");
  tr.innerHTML = `
    <td><input></td>
    <td><input type="number" value="1" min="1" onchange="calc()"></td>
    <td><input type="number" step="0.01" value="0" onchange="calc()"></td>
    <td class="right">0.00</td>
  `;
  tbody.appendChild(tr);
}

function calc() {
  let subtotal = 0;
  [...tbody.rows].forEach(r=>{
    const qty = Number(r.cells[1].children[0].value||0);
    const price = Number(r.cells[2].children[0].value||0);
    const amt = qty * price;
    r.cells[3].innerText = amt.toFixed(2);
    subtotal += amt;
  });
  subtotalEl.innerText = subtotal.toFixed(2);
  totalEl.innerText = subtotal.toFixed(2);
}

addItem();

async function submitPO() {
  errorCard.style.display = "none";
  errorBox.innerText = "";

  const items = [...tbody.rows].map(r=>({
    description: r.cells[0].children[0].value,
    qty: r.cells[1].children[0].value,
    price: r.cells[2].children[0].value
  }));

  const payload = {
    supplier_name: supplier_name.value,
    issued_by: issued_by.value,
    delivery_address: delivery_address.value,
    delivery_date: delivery_date.value,
    delivery_time: delivery_time.value,
    notes: notes.value,
    items
  };

  try {
    const res = await fetch("/api/po-create",{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      credentials:"include",
      body:JSON.stringify(payload)
    });

    const data = await res.json();

    if (!res.ok) {
      errorCard.style.display = "block";
      errorBox.innerText = JSON.stringify(data, null, 2);
      return;
    }

    alert("PO created successfully");
    location.href = "/pos.html";

  } catch (e) {
    errorCard.style.display = "block";
    errorBox.innerText = String(e);
  }
}
</script>

</body>
</html>
