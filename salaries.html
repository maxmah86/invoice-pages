<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Salaries</title>
<meta name="viewport" content="width=device-width, initial-scale=1">
<style>
body { font-family: Arial; background:#f5f5f5; margin:12px; }
h2 { text-align:center; }
label { display:block; margin-bottom:10px; }
input, button {
  width:100%; padding:12px; font-size:16px; box-sizing:border-box;
}
.card {
  background:#fff;
  padding:12px;
  border-radius:6px;
  margin-bottom:10px;
}
.small { font-size:14px; color:#666; }
.gen { background:#3498db; color:#fff; border:0; margin-bottom:12px; }
.pay { background:#27ae60; color:#fff; border:0; margin-top:6px; }
.pdf { background:#555; color:#fff; border:0; margin-top:6px; }
</style>
</head>

<body>

<h2>Salaries</h2>

<label>Month
  <input type="month" id="month">
</label>

<button class="gen" onclick="generate()">Generate DRAFT Salaries</button>

<div id="list"></div>

<script>
/* ===============================
   LOGIN REQUIRE
   =============================== */
(async () => {
  try {
    const r = await fetch("/api/auth-check");
    if (!r.ok) location.href = "login.html";
  } catch {
    location.href = "login.html";
  }
})();

/* ===============================
   INIT
   =============================== */
month.value = new Date().toISOString().slice(0,7);

/* ===============================
   LOAD SALARIES
   =============================== */
async function load() {
  const r = await fetch("/api/salaries?month=" + month.value);
  if (!r.ok) {
    alert("Failed to load salaries");
    return;
  }

  const data = await r.json();
  list.innerHTML = "";

  if (data.length === 0) {
    list.innerHTML = "<div class='small'>No salaries for this month.</div>";
    return;
  }

  data.forEach(s => {
    const div = document.createElement("div");
    div.className = "card";
    div.innerHTML = `
      <b>${s.name}</b><br>
      <span class="small">
        Base: RM ${s.base_salary}<br>
        Allowance: RM ${s.allowance}<br>
        Deduction: RM ${s.deduction}
      </span><br><br>
      <b>Net: RM ${s.net_salary}</b><br>
      <span class="small">Status: ${s.status}</span>
      ${s.status === 'DRAFT'
        ? `<button class="pay" onclick="pay(${s.id})">Mark as PAID</button>`
        : `<button class="pdf" onclick="viewPayslip(${s.id})">View Payslip</button>`
      }
    `;
    list.appendChild(div);
  });
}

/* ===============================
   GENERATE DRAFT
   =============================== */
async function generate() {
  if (!confirm("Generate DRAFT salaries for this month?")) return;

  const r = await fetch("/api/salary-create", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ salary_month: month.value })
  });

  if (r.ok) load();
  else alert("Failed to generate salaries");
}

/* ===============================
   PAY SALARY
   =============================== */
async function pay(id) {
  if (!confirm("Confirm mark as PAID?")) return;

  const r = await fetch("/api/salary-pay", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  });

  if (r.ok) load();
  else alert("Failed to update salary");
}

/* ===============================
   VIEW PAYSLIP (HTML)
   =============================== */
function viewPayslip(id) {
  window.open("payslip.html?id=" + id);
}

month.onchange = load;
load();
</script>

</body>
</html>
