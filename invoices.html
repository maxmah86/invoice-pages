<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<title>Invoices</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
  body {
    font-family: Arial, sans-serif;
    background: #f4f6f8;
    margin: 0;
    padding: 12px;
  }

  h2 {
    margin-top: 0;
  }

  .invoice {
    background: #fff;
    border-radius: 8px;
    padding: 12px;
    margin-bottom: 12px;
    border-left: 6px solid #ccc;
  }

  .invoice.paid {
    border-left-color: #27ae60;
  }

  .invoice.unpaid {
    border-left-color: #e74c3c;
  }

  .row {
    display: flex;
    justify-content: space-between;
    margin-bottom: 6px;
    font-size: 14px;
  }

  .label {
    color: #666;
  }

  .value {
    font-weight: bold;
  }

  .status {
    font-size: 13px;
    padding: 4px 8px;
    border-radius: 4px;
    color: #fff;
  }

  .status.PAID {
    background: #27ae60;
  }

  .status.UNPAID {
    background: #e74c3c;
  }

  .actions {
    display: flex;
    gap: 8px;
    margin-top: 10px;
  }

  .actions button {
    flex: 1;
    padding: 10px;
    font-size: 14px;
    border: none;
    border-radius: 6px;
    cursor: pointer;
  }

  .view-btn {
    background: #3498db;
    color: #fff;
  }

  .toggle-btn {
    background: #f1c40f;
    color: #000;
  }
</style>
</head>

<body>

<h2>Invoices</h2>

<div id="list">Loading…</div>

<script>
/* ===== 登录检查 ===== */
(async function checkAuth() {
  const res = await fetch("/api/auth-check", {
    credentials: "include"
  });
  if (!res.ok) {
    location.href = "/login.html";
  }
})();

/* ===== 加载 invoices ===== */
async function loadInvoices() {
  const res = await fetch("/api/invoices", {
    credentials: "include"
  });

  if (!res.ok) {
    location.href = "/login.html";
    return;
  }

  const data = await res.json();
  const list = document.getElementById("list");
  list.innerHTML = "";

  if (data.length === 0) {
    list.innerHTML = "<p>No invoices found.</p>";
    return;
  }

  data.forEach(inv => {
    const invoiceNo = inv.invoice_no || ("INV-" + inv.id);
    const div = document.createElement("div");
    div.className = "invoice " + (inv.status === "PAID" ? "paid" : "unpaid");

    div.innerHTML = `
      <div class="row">
        <span class="label">Invoice</span>
        <span class="value">${invoiceNo}</span>
      </div>

      <div class="row">
        <span class="label">Customer</span>
        <span class="value">${inv.customer}</span>
      </div>

      <div class="row">
        <span class="label">Amount</span>
        <span class="value">RM ${Number(inv.amount).toFixed(2)}</span>
      </div>

      <div class="row">
        <span class="label">Status</span>
        <span class="status ${inv.status}">${inv.status}</span>
      </div>

      <div class="actions">
        <button class="view-btn"
          onclick="viewInvoice(${inv.id})">
          View
        </button>

        <button class="toggle-btn"
          onclick="toggleStatus(${inv.id}, '${inv.status}')">
          ${inv.status === "PAID" ? "Mark UNPAID" : "Mark PAID"}
        </button>
      </div>
    `;

    list.appendChild(div);
  });
}

/* ===== 切换状态 ===== */
async function toggleStatus(id, current) {
  const next = current === "PAID" ? "UNPAID" : "PAID";

  const res = await fetch("/api/invoice-status", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id, status: next })
  });

  if (res.ok) {
    loadInvoices();
  } else {
    alert("Failed to update status");
  }
}

/* ===== 查看 invoice ===== */
function viewInvoice(id) {
  location.href = "/invoice-view.html?id=" + id;
}

loadInvoices();
</script>

</body>
</html>
