<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Invoices</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  margin: 16px;
  background: #f5f5f5;
}

h1 {
  margin-top: 0;
}

.filter-box {
  background: #fff;
  padding: 12px;
  border-radius: 6px;
  margin-bottom: 12px;
}

.filter-box label {
  font-size: 13px;
  font-weight: bold;
  display: block;
  margin-top: 6px;
}

.filter-box input,
.filter-box select {
  width: 100%;
  padding: 8px;
  font-size: 14px;
  margin-top: 4px;
}

.list {
  background: #fff;
  border-radius: 6px;
  overflow: hidden;
}

.item {
  border-bottom: 1px solid #eee;
  padding: 12px;
}

.item:last-child {
  border-bottom: none;
}

.row {
  font-size: 14px;
  margin-bottom: 4px;
}

.status {
  font-weight: bold;
}

.UNPAID { color: #1c7ed6; }
.PAID { color: #2f9e44; }
.VOID { color: #c92a2a; }

.actions {
  margin-top: 6px;
  display: flex;
  gap: 6px;
}

.actions button {
  padding: 6px 10px;
  font-size: 12px;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>Invoices</h1>

<!-- ===== Filters ===== -->
<div class="filter-box">
  <label>Status</label>
  <select id="filterStatus" onchange="applyFilter()">
    <option value="">ALL</option>
    <option value="UNPAID">UNPAID</option>
    <option value="PAID">PAID</option>
    <option value="VOID">VOID</option>
  </select>

  <label>Invoice No</label>
  <input id="filterInvoiceNo" placeholder="Search invoice no" oninput="applyFilter()">

  <label>Customer</label>
  <input id="filterCustomer" placeholder="Search customer" oninput="applyFilter()">
</div>

<!-- ===== Invoice List ===== -->
<div class="list" id="list"></div>

<script>
let invoices = [];

fetch("/api/invoices", { credentials: "include" })
.then(res => {
  if (res.status === 401) {
    location.replace("/login.html");
    throw new Error("Unauthorized");
  }
  return res.json();
})
.then(data => {
  invoices = data;
  render(invoices);
});

function applyFilter() {
  const status = document.getElementById("filterStatus").value;
  const invoiceNo = document.getElementById("filterInvoiceNo").value.toLowerCase();
  const customer = document.getElementById("filterCustomer").value.toLowerCase();

  const filtered = invoices.filter(inv => {
    if (status && inv.status !== status) return false;
    if (invoiceNo && !inv.invoice_no.toLowerCase().includes(invoiceNo)) return false;
    if (customer && !inv.customer.toLowerCase().includes(customer)) return false;
    return true;
  });

  render(filtered);
}

function render(list) {
  const container = document.getElementById("list");
  container.innerHTML = "";

  if (!list.length) {
    container.innerHTML = "<div class='item'>No invoices found</div>";
    return;
  }

  list.forEach(inv => {
    const div = document.createElement("div");
    div.className = "item";

    div.innerHTML = `
      <div class="row"><strong>${inv.invoice_no}</strong></div>
      <div class="row">Customer: ${inv.customer}</div>
      <div class="row">Total: RM ${inv.amount.toFixed(2)}</div>
      <div class="row status ${inv.status}">${inv.status}</div>
      <div class="actions">
        <button onclick="view(${inv.id})">View</button>
        ${renderActionButton(inv)}
      </div>
    `;
    container.appendChild(div);
  });
}

function renderActionButton(inv) {
  if (inv.status === "UNPAID") {
    return `<button onclick="setStatus(${inv.id}, 'PAID')">Mark PAID</button>`;
  }
  if (inv.status === "PAID") {
    return `<button onclick="setStatus(${inv.id}, 'UNPAID')">Mark UNPAID</button>`;
  }
  return "";
}

function view(id) {
  location.href = `/invoice-view.html?id=${id}`;
}

async function setStatus(id, status) {
  if (!confirm(`Set invoice to ${status}?`)) return;

  const res = await fetch("/api/invoice-status", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ id, status })
  });

  if (!res.ok) {
    alert("Failed to update status");
    return;
  }

  // 本地更新状态（不用 reload）
  const inv = invoices.find(i => i.id === id);
  if (inv) inv.status = status;

  applyFilter();
}
</script>

</body>
</html>
