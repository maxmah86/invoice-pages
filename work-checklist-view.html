<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Work Checklist</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<style>
  body { font-family: Arial, sans-serif; background: #f4f6f8; margin: 0; padding: 14px; }
  .subtitle { 
    background: #fff; padding: 12px; border-radius: 8px; 
    border-left: 5px solid #3498db; margin-bottom: 16px; font-size: 14px; 
    box-shadow: 0 1px 3px rgba(0,0,0,0.1); line-height: 1.6;
  }
  .project-title { color: #2c3e50; font-weight: bold; font-size: 16px; margin-top: 5px; }
  .card { background: #fff; border-radius: 8px; padding: 14px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
  .item { border-bottom: 1px solid #eee; padding: 16px 0; }
  .item:last-child { border-bottom: none; }
  .desc { font-size: 16px; font-weight: bold; margin-bottom: 10px; color: #333; }
  
  /* çŠ¶æ€æŒ‰é’®æ ·å¼ */
  .status-btn { 
    display: inline-block; padding: 8px 16px; border-radius: 20px; 
    font-size: 13px; font-weight: bold; cursor: pointer; 
    text-align: center; min-width: 100px; transition: all 0.2s;
  }
  .NOT_STARTED { background: #e0e0e0; color: #666; }
  .IN_PROGRESS { background: #f39c12; color: #fff; }
  .DONE { background: #27ae60; color: #fff; }
  
  /* Section ç‰¹æ®Šæ ·å¼ */
  .SECTION-ROW { 
    background: #f9f9f9; padding: 10px; border-radius: 6px; 
    text-align: center; color: #7f8c8d; font-weight: bold; 
    border: 1px dashed #ccc; margin: 15px 0 10px 0; 
  }
  
  .remarks { margin-top: 12px; }
  textarea { 
    width: 100%; box-sizing: border-box; margin-top: 8px; 
    padding: 10px; border-radius: 6px; border: 1px solid #ccc; 
    font-size: 14px; font-family: inherit;
  }
  textarea:focus { border-color: #3498db; outline: none; }
  .saving { opacity: 0.5; pointer-events: none; }

  button.btn-back {
    width: 100%; padding: 14px; font-size: 16px; border-radius: 6px;
    border: none; cursor: pointer; background: #34495e; color: #fff; margin-top: 15px;
  }
</style>
</head>
<body>

<h1>Work Checklist</h1>
<div class="subtitle" id="headerInfo">Loading project details...</div>

<div class="card" id="itemsBox">
  <div style="text-align: center; padding: 20px;">Loading items...</div>
</div>

<button class="btn-back" onclick="location.href='/dashboard.html'">Back to Dashboard</button>

<script>
const checklistId = new URLSearchParams(location.search).get("id");

/* ===== 1. åŠ è½½æ•°æ®å¹¶æ¸²æŸ“ UI ===== */
async function loadChecklist() {
  try {
    const res = await fetch(`/api/work-checklist-view?id=${checklistId}`, { credentials: "include" });
    if (!res.ok) throw new Error();
    const data = await res.json();

    // æ¸²æŸ“é¡¶ç«¯ä¿¡æ¯
    document.getElementById("headerInfo").innerHTML = `
      <div>Quotation: <b>${data.checklist.quotation_no || data.checklist.quotation_id}</b></div>
      <div class="project-title">ğŸ“ ${data.checklist.project_title || 'Project'}</div>
      <div style="color:#7f8c8d;">${data.checklist.project_address || 'No Address Provided'}</div>
    `;

    const box = document.getElementById("itemsBox");
    box.innerHTML = "";

    data.items.forEach(it => {
      const div = document.createElement("div");
      
      // åˆ¤æ–­æ˜¯å¦æ˜¯ Section æ ‡é¢˜
      if (it.status === 'SECTION') {
        div.className = "SECTION-ROW";
        div.textContent = it.description;
      } else {
        div.className = "item";
        div.innerHTML = `
          <div class="desc">${it.description}</div>
          <div 
            class="status-btn ${it.status}" 
            id="btn-${it.id}" 
            onclick="toggleStatus(${it.id}, '${it.status}')"
          >
            ${it.status.replace('_', ' ')}
          </div>
          <div class="remarks">
            <textarea 
              id="remarks-${it.id}"
              placeholder="Add worker remarks..." 
              onblur="saveRemarks(${it.id}, this.value)"
            >${it.remarks || ""}</textarea>
          </div>
        `;
      }
      box.appendChild(div);
    });
  } catch (err) {
    document.getElementById("itemsBox").innerHTML = "<div style='color:red;text-align:center;'>Failed to load checklist.</div>";
  }
}

/* ===== 2. çŠ¶æ€åˆ‡æ¢é€»è¾‘ (ä¿®å¤æ— æ³•åˆ‡æ¢é—®é¢˜) ===== */
function getNextStatus(current) {
  if (current === "NOT_STARTED") return "IN_PROGRESS";
  if (current === "IN_PROGRESS") return "DONE";
  return "IN_PROGRESS"; // DONE ä¹‹åç‚¹ä¸€ä¸‹å›åˆ°è¿›è¡Œä¸­
}

async function toggleStatus(id, current) {
  const next = getNextStatus(current);
  const btn = document.getElementById(`btn-${id}`);

  // è§†è§‰åé¦ˆ
  const oldText = btn.textContent;
  btn.textContent = "Updating...";
  btn.style.opacity = "0.7";

  try {
    const res = await fetch("/api/work-checklist-item-update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ item_id: id, status: next })
    });

    if (res.ok) {
      // æ›´æ–°æˆåŠŸï¼šæ”¹å˜é¢œè‰²ã€æ–‡æœ¬å’Œç‚¹å‡»äº‹ä»¶
      btn.className = `status-btn ${next}`;
      btn.textContent = next.replace('_', ' ');
      btn.style.opacity = "1";
      btn.setAttribute("onclick", `toggleStatus(${id}, '${next}')`);
    } else {
      throw new Error();
    }
  } catch (err) {
    alert("Update failed. Please check your connection.");
    btn.textContent = oldText;
    btn.style.opacity = "1";
  }
}

/* ===== 3. ä¿å­˜å¤‡æ³¨é€»è¾‘ (ä¿®å¤æ— æ³•ä¿å­˜é—®é¢˜) ===== */
async function saveRemarks(id, remarks) {
  const textarea = document.getElementById(`remarks-${id}`);
  textarea.classList.add("saving"); // å˜æ·¡è¡¨ç¤ºæ­£åœ¨ä¿å­˜

  try {
    const res = await fetch("/api/work-checklist-item-remarks", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ id: id, remarks: remarks })
    });

    if (!res.ok) throw new Error();
    console.log(`Remarks saved for item ${id}`);
  } catch (err) {
    alert("Remarks failed to save.");
  } finally {
    textarea.classList.remove("saving");
  }
}

// é¡µé¢åŠ è½½æ—¶è¿è¡Œ
loadChecklist();
</script>
</body>
</html>
