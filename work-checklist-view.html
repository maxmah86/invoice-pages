<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Work Checklist</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 14px;
}

h1 {
  margin-bottom: 12px;
}

/* ===== Header ===== */
.subtitle {
  background: #fff;
  padding: 12px;
  border-radius: 8px;
  border-left: 5px solid #3498db;
  margin-bottom: 16px;
  font-size: 14px;
  line-height: 1.6;
  box-shadow: 0 1px 3px rgba(0,0,0,0.1);
}

.project-title {
  font-weight: bold;
  font-size: 16px;
  color: #2c3e50;
}

/* ===== Card ===== */
.card {
  background: #fff;
  border-radius: 8px;
  padding: 14px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

/* ===== Section ===== */
.section-row {
  margin: 18px 0 10px;
  padding: 10px 12px;
  background: #f7f9fb;
  border-left: 4px solid #3498db;
  border-radius: 6px;
  font-weight: bold;
  color: #2c3e50;
}

/* ===== Item ===== */
.item {
  border-bottom: 1px solid #eee;
  padding: 14px 0;
}
.item:last-child {
  border-bottom: none;
}

.desc {
  font-size: 15px;
  font-weight: bold;
  margin-bottom: 10px;
  color: #333;
}

/* ===== Status button ===== */
.status-btn {
  display: inline-block;
  padding: 8px 16px;
  border-radius: 20px;
  font-size: 13px;
  font-weight: bold;
  cursor: pointer;
  min-width: 110px;
  text-align: center;
}

.NOT_STARTED { background: #e0e0e0; color: #666; }
.IN_PROGRESS { background: #f39c12; color: #fff; }
.DONE { background: #27ae60; color: #fff; }

/* ===== Remarks ===== */
.remarks {
  margin-top: 12px;
}
textarea {
  width: 100%;
  box-sizing: border-box;
  padding: 10px;
  border-radius: 6px;
  border: 1px solid #ccc;
  font-size: 14px;
}

/* ===== Buttons ===== */
.btn-back {
  width: 100%;
  margin-top: 18px;
  padding: 14px;
  font-size: 16px;
  border-radius: 6px;
  border: none;
  background: #34495e;
  color: #fff;
  cursor: pointer;
}

.btn-remove-checklist {
  width: 100%;
  margin-bottom: 12px;
  padding: 14px;
  font-size: 15px;
  border-radius: 6px;
  border: none;
  background: #e74c3c;
  color: #fff;
  cursor: pointer;
}
</style>
</head>

<body>

<h1>Work Checklist</h1>
<button onclick="window.location.href='/index.html';">HOME</button>

<!-- admin-only action -->
<div id="adminActions"></div>

<div class="subtitle" id="headerInfo">
  Loading project details...
</div>

<div class="card" id="itemsBox">
  <div style="text-align:center;padding:20px;">Loading items...</div>
</div>

<button class="btn-back" onclick="history.back()">Back</button>

<script>
const checklistId = Number(
  new URLSearchParams(location.search).get("id")
);
let IS_ADMIN = false;

/* ===============================
 * Check role
 * =============================== */
async function checkRole() {
  const res = await fetch("/api/auth-check", {
    credentials: "include"
  });
  const data = await res.json();

  IS_ADMIN = data.role === "admin";

  if (IS_ADMIN) {
    document.getElementById("adminActions").innerHTML = `
      <button
        class="btn-remove-checklist"
        onclick="removeChecklist()"
      >
        üóë Remove Checklist
      </button>
    `;
  }
}

/* ===============================
 * Load checklist
 * =============================== */
async function loadChecklist() {
  const res = await fetch(
    `/api/work-checklist-view?id=${checklistId}`,
    { credentials: "include" }
  );

  if (!res.ok) {
    document.getElementById("itemsBox").innerHTML =
      "<div style='color:red;text-align:center;'>Failed to load checklist</div>";
    return;
  }

  const data = await res.json();

  document.getElementById("headerInfo").innerHTML = `
    <div>Quotation: <b>${data.checklist.quotation_no}</b></div>
    <div class="project-title">üìç ${data.checklist.project_title || "-"}</div>
    <div style="color:#7f8c8d;">
      ${data.checklist.project_address || ""}
    </div>
  `;

  const box = document.getElementById("itemsBox");
  box.innerHTML = "";

  data.items.forEach(it => {
    const div = document.createElement("div");

    if (it.status === "SECTION") {
      div.className = "section-row";
      div.textContent = it.description;
    } else {
      div.className = "item";
      div.innerHTML = `
        <div class="desc">${it.description}</div>

        <div
          class="status-btn ${it.status}"
          onclick="toggleStatus(${it.id}, '${it.status}')"
        >
          ${it.status.replace("_", " ")}
        </div>

        <div class="remarks">
          <textarea
            onblur="saveRemarks(${it.id}, this.value)"
          >${it.remarks || ""}</textarea>
        </div>
      `;
    }

    box.appendChild(div);
  });
}

/* ===============================
 * Remove checklist (admin only)
 * =============================== */
async function removeChecklist() {
  if (
    !confirm(
      "This will permanently delete the entire checklist.\nAre you sure?"
    )
  ) return;

  try {
    const res = await fetch("/api/work-checklist-delete", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify({ id: checklistId })
    });

    const text = await res.text();

    console.log("DELETE STATUS:", res.status);
    console.log("DELETE RESPONSE:", text);

    if (!res.ok) {
      alert(`Delete failed (${res.status}):\n${text}`);
      return;
    }

    // ‚úÖ Âè™ÊúâÊàêÂäüÊâçË∑≥È°µ
    location.href = "/work-checklist.html";

  } catch (err) {
    console.error(err);
    alert("Network / JS error");
  }
}

/* ===============================
 * Status & remarks (existing)
 * =============================== */
function getNextStatus(c) {
  if (c === "NOT_STARTED") return "IN_PROGRESS";
  if (c === "IN_PROGRESS") return "DONE";
  return "IN_PROGRESS";
}

async function toggleStatus(id, current) {
  await fetch("/api/work-checklist-item-update", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({
      item_id: id,
      status: getNextStatus(current)
    })
  });
  loadChecklist();
}

async function saveRemarks(id, remarks) {
  await fetch("/api/work-checklist-item-remarks", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ id, remarks })
  });
}

/* Init */
(async () => {
  if (!Number.isInteger(checklistId)) {
    alert("Invalid checklist id");
    return;
  }
  await checkRole();
  await loadChecklist();
})();
</script>

</body>
</html>
