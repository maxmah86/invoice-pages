<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Edit Purchase Order</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
/* 复用 po.html 的样式以保持 UI 一致性 */
body { font-family: Arial, sans-serif; margin: 16px; color: #000; }
h1 { margin-bottom: 12px; }
.form-group { margin-bottom: 14px; }
label { display: block; font-size: 14px; font-weight: bold; margin-bottom: 4px; }
input, textarea { width: 100%; box-sizing: border-box; padding: 6px; font-size: 14px; }
textarea { min-height: 60px; }
table { width: 100%; border-collapse: collapse; margin-top: 10px; }
th, td { border: 1px solid #000; padding: 6px; font-size: 13px; }
th { background: #f0f0f0; }
.text-right { text-align: right; }
button { padding: 8px 14px; font-size: 14px; margin-top: 10px; cursor: pointer; }
.btn-save { background: #27ae60; color: white; border: none; border-radius: 4px; }
.total { font-size: 16px; font-weight: bold; text-align: right; margin-top: 10px; }
#errorBox { display: none; margin-top: 16px; padding: 10px; border: 1px solid #c00; background: #fff3f3; font-size: 13px; white-space: pre-wrap; }
#loadingOverlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(255,255,255,0.8); display: flex; justify-content: center; align-items: center; z-index: 1000; }
</style>
</head>

<body>

<div id="loadingOverlay">Loading PO Data...</div>

<h1>Edit Purchase Order</h1>

<div class="form-group">
  <label>Supplier Name *</label>
  <input id="supplier_name" placeholder="Required">
</div>

<div class="form-group">
  <label>PO Date</label>
  <input type="date" id="po_date">
</div>

<div class="form-group">
  <label>Issued By</label>
  <input id="issued_by">
</div>

<div class="form-group">
  <label>Delivery Address</label>
  <textarea id="delivery_address"></textarea>
</div>

<div class="form-group">
  <label>Delivery Date</label>
  <input type="date" id="delivery_date">
</div>

<div class="form-group">
  <label>Delivery Time</label>
  <input id="delivery_time">
</div>

<div class="form-group">
  <label>Notes</label>
  <textarea id="notes"></textarea>
</div>

<h3>Items *</h3>
<table>
  <thead>
    <tr>
      <th style="width:5%">No</th>
      <th>Description</th>
      <th style="width:10%">Qty</th>
      <th style="width:15%">Unit Price</th>
      <th style="width:15%">Amount (RM)</th>
      <th style="width:5%"></th>
    </tr>
  </thead>
  <tbody id="items"></tbody>
</table>

<button onclick="addRow()">+ Add Item</button>

<div class="total">
  TOTAL (RM): <span id="total">0.00</span>
</div>

<br>

<button class="btn-save" onclick="updatePO()">Update & Save Changes</button>
<button onclick="history.back()">Cancel</button>

<div id="errorBox"></div>

<script>
// 获取 URL 中的 ID 参数
const poId = new URLSearchParams(location.search).get("id");

if (!poId) {
    alert("No PO ID provided");
    location.href = "/pos.html";
}

/**
 * 1. 初始化：加载现有 PO 数据
 */
async function loadPOData() {
    try {
        const res = await fetch(`/api/po-view?id=${poId}`, { credentials: "include" });
        if (res.status === 401) {
            location.replace("/login.html");
            return;
        }
        const result = await res.json();
        const po = result.po;

        // 填充主表单字段
        document.getElementById("supplier_name").value = po.supplier_name || "";
        document.getElementById("po_date").value = po.po_date || "";
        document.getElementById("issued_by").value = po.issued_by || "";
        document.getElementById("delivery_address").value = po.delivery_address || "";
        document.getElementById("delivery_date").value = po.delivery_date || "";
        document.getElementById("delivery_time").value = po.delivery_time || "";
        document.getElementById("notes").value = po.notes || "";

        // 填充项目行
        const tbody = document.getElementById("items");
        tbody.innerHTML = ""; 
        if (result.items && result.items.length > 0) {
            result.items.forEach(item => addRow(item));
        } else {
            addRow();
        }

        document.getElementById("loadingOverlay").style.display = "none";
    } catch (err) {
        console.error(err);
        alert("Failed to load PO data");
    }
}

/**
 * 2. 动态添加行功能
 */
function addRow(item = {}) {
  const tbody = document.getElementById("items");
  const tr = document.createElement("tr");

  tr.innerHTML = `
    <td></td>
    <td><input class="desc" value="${item.description || ""}"></td>
    <td><input type="number" class="qty text-right" value="${item.qty || 0}" oninput="calc()"></td>
    <td><input type="number" class="price text-right" value="${item.price || 0}" oninput="calc()"></td>
    <td class="text-right amount">0.00</td>
    <td><button onclick="this.closest('tr').remove(); calc()">X</button></td>
  `;

  tbody.appendChild(tr);
  calc();
}

/**
 * 3. 自动计算总额
 */
function calc() {
  let total = 0;
  document.querySelectorAll("#items tr").forEach((tr, i) => {
    tr.children[0].textContent = i + 1;
    const qty = Number(tr.querySelector(".qty").value) || 0;
    const price = Number(tr.querySelector(".price").value) || 0;
    const amount = qty * price;
    tr.querySelector(".amount").textContent = amount.toFixed(2);
    total += amount;
  });
  document.getElementById("total").textContent = total.toFixed(2);
}

/**
 * 4. 提交更新
 */
async function updatePO() {
  const errorBox = document.getElementById("errorBox");
  errorBox.style.display = "none";

  const items = [];
  document.querySelectorAll("#items tr").forEach(tr => {
    items.push({
      description: tr.querySelector(".desc").value,
      qty: Number(tr.querySelector(".qty").value) || 0,
      price: Number(tr.querySelector(".price").value) || 0
    });
  });

  if (!document.getElementById("supplier_name").value) {
    alert("Supplier Name is required");
    return;
  }

  const payload = {
    id: poId, // 必须包含 ID 以供后端识别更新对象
    supplier_name: document.getElementById("supplier_name").value,
    po_date: document.getElementById("po_date").value,
    issued_by: document.getElementById("issued_by").value,
    delivery_address: document.getElementById("delivery_address").value,
    delivery_date: document.getElementById("delivery_date").value,
    delivery_time: document.getElementById("delivery_time").value,
    notes: document.getElementById("notes").value,
    items
  };

  try {
    const res = await fetch("/api/po-update", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      credentials: "include",
      body: JSON.stringify(payload)
    });

    if (!res.ok) {
        const text = await res.text();
        throw new Error(text);
    }

    alert("PO updated successfully");
    location.href = `/po-view.html?id=${poId}`; // 返回查看页面

  } catch (err) {
    errorBox.style.display = "block";
    errorBox.textContent = "Update failed:\n" + err.message;
  }
}

// 启动加载
loadPOData();
</script>

</body>
</html>
