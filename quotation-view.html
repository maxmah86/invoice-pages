<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Quotation</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<!-- Config -->
<script src="/js/config.js"></script>
<script src="/js/company-settings.js"></script>

<style>
body {
  font-family: Arial, sans-serif;
  margin: 16px;
  color: #000;
}

/* ===== HEADER ===== */
.header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
}

.amount-zero {
  color: transparent;
}

#company-logo {
  width: 80px;
  height: auto;
}

.company-header {
  display: flex;
  gap: 10px;
}

.company-logo {
  width: 60px;
}

.company h1 {
  margin: 0;
  font-size: 22px;
}

/* ===== TABLE ===== */
table {
  width: 100%;
  border-collapse: collapse;
  margin-top: 20px;
}

th, td {
  border: 1px solid #000;
  padding: 6px;
  font-size: 13px;
}

th {
  background: #f0f0f0;
}

.right {
  text-align: right;
}

/* ===== SECTION ===== */
.section-title td {
  font-weight: bold;
  background: #eee;
}

.section-subtotal td,
.grand-total td {
  font-weight: bold;
  background: #f5f5f5;
}

/* ===== INFO ===== */
.project-info {
  margin-top: 20px;
  font-size: 14px;
}

/* ===== TERMS ===== */
.terms {
  margin-top: 30px;
  font-size: 13px;
  white-space: pre-line;
}

/* ===== SIGNATURE ===== */
.signature {
  margin-top: 50px;
  display: flex;
  justify-content: flex-end;
}

.signature-box {
  text-align: center;
  font-size: 13px;
}

.signature-box img {
  width: 120px;
}

/* ===== PRINT ===== */
@media print {
  .no-print { display: none; }
  tr { page-break-inside: avoid; }
}
</style>
</head>

<body>

<div class="no-print" id="action-buttons" style="text-align:right; margin-bottom:10px;">
  <button onclick="goEdit()">Edit</button>
  <button onclick="approveQuotation()">Approve</button>
  <button onclick="rejectQuotation()">Reject</button>
</div>

<div class="no-print" style="text-align:right">
  <button onclick="window.print()">Print</button>
</div>

<!-- ================= HEADER ================= -->
<div class="header">
  <div class="company" id="companyInfo">
    <div class="company-header">
      <img id="company-logo" alt="Company Logo">
      <div class="company-text">
        <h1 id="comp-name">Loading...</h1>
        <div id="comp-reg" class="ssm-code"></div>
      </div>
    </div>
    <address style="font-style: normal;">
      <div id="comp-address"></div>
      <div id="comp-contact"></div>
    </address>
  </div>

  <div>
    <h2>QUOTATION</h2>
    <div>No: <span id="quotation_no"></span></div>
    <div>Date: <span id="quotation_date"></span></div>
  </div>
</div>

<!-- ================= PROJECT ================= -->
<div class="project-info">
  <div><strong>Customer:</strong> <span id="customer"></span></div>
  <div><strong>Project:</strong> <span id="project_title"></span></div>
  <div><strong>Address:</strong> <span id="project_address"></span></div>
</div>

<!-- ================= ITEMS ================= -->
<table>

  <thead>
  <tr>
    <th style="width:5%">No</th>
    <th>Description</th>
    <th style="width:8%">UOM</th>
    <th style="width:8%">Qty</th>
    <th style="width:12%">Unit Price</th>
    <th style="width:15%">Amount</th>
  </tr>
</thead>


  <tbody id="items"></tbody>
</table>

<!-- ================= BANK ================= -->


<div class="bank-info" style="margin-top:20px; font-size:13px; line-height:1.3;">

  <div style="margin-bottom:6px;">
    <strong>ALL CHEQUES TO BE CROSSED AND MADE PAYABLE TO THE ORDER OF</strong>
    <strong class="company-name"></strong>
  </div>

  <div style="margin-bottom:4px;">
    <strong>Bank Details</strong><br>
    <strong class="company-name"></strong>
  </div>

  <div>
    <span id="bank-info"></span>
  </div>

</div>




<!-- ================= TERMS ================= -->
<div class="terms">
  <strong>Terms & Conditions</strong>
  <div id="terms"></div>
</div>

<!-- ================= SIGNATURE ================= -->
<div class="signature">
  <div class="signature-box">
    <img id="company-chop">
    <div id="authorized-title"></div>
    <div><strong id="authorized-name"></strong></div>
  </div>
</div>


<script>
const id = new URL(location.href).searchParams.get("id");
const CURRENCY = CONFIG.CURRENCY || "RM";

function qid(id){ return document.getElementById(id); }

/* ================= LOAD DATA ================= */
fetch("/api/quotation-view?id=" + id)
  .then(r => r.json())
  .then(json => {
    if (!json.success) {
      alert(json.error || "Load failed");
      return;
    }

    const q = json.data;
    const sections = q.sections || [];

    // header
    qid("quotation_no").innerText = q.quotation_no;
    qid("quotation_date").innerText = q.created_at?.slice(0,10) || "";
    qid("customer").innerText = q.customer;
    qid("project_title").innerText = q.project_title || "";
    qid("project_address").innerText = q.project_address || "";
    qid("terms").innerText = q.terms_snapshot || "";

    renderItems(sections, q.discount || 0);
  });

/* ================= ACTIONS ================= */

function goEdit() {
  location.href = "/quotation-edit.html?id=" + id;
}

async function approveQuotation() {
  if (!confirm("Approve this quotation?")) return;

  const res = await fetch("/api/quotation-accept", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    credentials: "include",
    body: JSON.stringify({ id })
  });

  const json = await res.json();
  if (!json.success) {
    alert(json.error || "Approve failed");
    return;
  }

  alert("Quotation approved");
  location.reload();
}

async function rejectQuotation() {
  const reason = prompt("Reject reason (optional):");
  if (reason === null) return;

  if (!confirm("Reject this quotation?")) return;

  const res = await fetch("/api/quotation-reject", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({
      quotation_id: id,
      reason
    })
  });

  if (!res.ok) {
    alert("Reject failed");
    return;
  }

  alert("Quotation rejected");
  location.href = "/quotations.html";
}

/* ================= RENDER ITEMS ================= */

function renderItems(sections, discount) {
  const tbody = qid("items");
  tbody.innerHTML = "";

  let grandTotal = 0;

  sections.forEach(sec => {
    tbody.insertAdjacentHTML(
      "beforeend",
      `<tr class="section-title">
        <td colspan="6">${sec.section_title}</td>
      </tr>`
    );

    let sectionTotal = 0;

    sec.items.forEach(it => {
      const qty = Number(it.qty) || 0;
      const unitPrice = Number(it.unit_price) || 0;
      const line = Number(it.line_total) || 0;

      sectionTotal += line;
      grandTotal += line;

      // ⭐ 统一规则：值为 0 → 透明
      const qtyClass   = qty === 0 ? "right amount-zero" : "right";
      const priceClass = unitPrice === 0 ? "right amount-zero" : "right";
      const amtClass   = line === 0 ? "right amount-zero" : "right";

      tbody.insertAdjacentHTML(
        "beforeend",
        `<tr>
          <td>${it.item_no || ""}</td>
          <td>${it.description}</td>
          <td class="right">${it.UOM || ""}</td>
          <td class="${qtyClass}">${qty}</td>
          <td class="${priceClass}">${unitPrice.toFixed(2)}</td>
          <td class="${amtClass}">${line.toFixed(2)}</td>
        </tr>`
      );
    });

    tbody.insertAdjacentHTML(
      "beforeend",
      `<tr class="section-subtotal">
        <td colspan="5" class="right">Subtotal</td>
        <td class="right">${sectionTotal.toFixed(2)}</td>
      </tr>`
    );
  });

  if (discount > 0) {
    tbody.insertAdjacentHTML(
      "beforeend",
      `<tr>
        <td colspan="5" class="right">Discount</td>
        <td class="right">-${discount.toFixed(2)}</td>
      </tr>`
    );
  }

  tbody.insertAdjacentHTML(
    "beforeend",
    `<tr class="grand-total">
      <td colspan="5" class="right">TOTAL (${CURRENCY})</td>
      <td class="right">${(grandTotal - discount).toFixed(2)}</td>
    </tr>`
  );
}

/* ================= COMPANY ================= */
document.addEventListener("DOMContentLoaded", () => {
  if (!window.COMPANY_CONFIG) return;

  qid("company-logo").src = COMPANY_CONFIG.logoUrl || "";
  qid("comp-name").innerText = COMPANY_CONFIG.name;
  qid("comp-reg").innerText = COMPANY_CONFIG.regNo || "";
  qid("comp-address").innerText = COMPANY_CONFIG.address || "";
  qid("comp-contact").innerText =
    `Tel: ${COMPANY_CONFIG.phone} | Email: ${COMPANY_CONFIG.email}`;

  qid("bank-info").innerText =
    `${COMPANY_CONFIG.bankName} : ${COMPANY_CONFIG.bankAcc}`;

  qid("company-chop").src = COMPANY_CONFIG.chopUrl || "";
  qid("authorized-title").innerText =
    COMPANY_CONFIG.authorizedTitle || "Authorized Signature";
  qid("authorized-name").innerText = COMPANY_CONFIG.name;
});
</script>

</body>
</html>