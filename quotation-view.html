<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Quotation View</title>
<meta name="viewport" content="width=device-width, initial-scale=1" />

<style>
body {
  font-family: Arial, sans-serif;
  margin: 16px;
  background: #f5f5f5;
}

h1 {
  margin-bottom: 8px;
}

.card {
  background: #fff;
  padding: 14px;
  border-radius: 8px;
  margin-bottom: 12px;
}

.row {
  margin-bottom: 6px;
  font-size: 15px;
}

.label {
  color: #666;
}

.value {
  font-weight: bold;
}

.status {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 13px;
}

.status.OPEN {
  background: #2196f3;
  color: #fff;
}

.status.ACCEPTED {
  background: #4caf50;
  color: #fff;
}

.status.VOID {
  background: #9e9e9e;
  color: #fff;
}

.item {
  border-top: 1px solid #eee;
  padding-top: 8px;
  margin-top: 8px;
}

.actions {
  display: flex;
  gap: 10px;
  margin-top: 14px;
}

button {
  flex: 1;
  padding: 12px;
  font-size: 15px;
  border: none;
  border-radius: 6px;
}

.btn-view { background: #607d8b; color: #fff; }
.btn-edit { background: #ff9800; color: #fff; }
.btn-convert { background: #4caf50; color: #fff; }

.total {
  text-align: right;
  font-size: 18px;
  font-weight: bold;
  margin-top: 10px;
}
</style>
</head>

<body>

<h1>Quotation</h1>

<div class="card">
  <div class="row">
    <span class="label">Quotation No:</span>
    <span class="value" id="quotationNo"></span>
  </div>
  <div class="row">
    <span class="label">Customer:</span>
    <span class="value" id="customer"></span>
  </div>
  <div class="row">
    <span class="label">Status:</span>
    <span id="status"></span>
  </div>
  <div class="row">
    <span class="label">Date:</span>
    <span class="value" id="date"></span>
  </div>
</div>

<div class="card">
  <h3>Items</h3>
  <div id="items"></div>
  <div class="total">
    Total: RM <span id="total"></span>
  </div>
</div>

<div class="actions" id="actions"></div>

<script>
const id = new URLSearchParams(location.search).get("id");

if (!id) {
  alert("Missing quotation id");
  location.href = "/quotations.html";
}

fetch(`/api/quotation-view?id=${id}`, { credentials: "include" })
  .then(res => {
    if (res.status === 401) {
      location.href = "/login.html";
      throw new Error("Unauthorized");
    }
    return res.json();
  })
  .then(data => {
    const q = data.quotation;

    document.getElementById("quotationNo").textContent = q.quotation_no;
    document.getElementById("customer").textContent = q.customer;
    document.getElementById("date").textContent = q.created_at;

    const statusSpan = document.getElementById("status");
    statusSpan.textContent = q.status;
    statusSpan.className = `status ${q.status}`;

    let total = 0;
    const itemsDiv = document.getElementById("items");

    data.items.forEach(i => {
      const amount = i.qty * i.price;
      total += amount;

      const div = document.createElement("div");
      div.className = "item";
      div.innerHTML = `
        <div><strong>${i.description}</strong></div>
        <div>Qty: ${i.qty}</div>
        <div>Price: RM ${i.price.toFixed(2)}</div>
        <div>Subtotal: RM ${amount.toFixed(2)}</div>
      `;
      itemsDiv.appendChild(div);
    });

    document.getElementById("total").textContent = total.toFixed(2);

    renderActions(q.status);
  })
  .catch(err => alert(err.message));

function renderActions(status) {
  const actions = document.getElementById("actions");
  actions.innerHTML = "";

  if (status === "OPEN") {
    actions.innerHTML = `
      <button class="btn-edit" onclick="edit()">Edit</button>
      <button class="btn-convert" onclick="convert()">Convert</button>
    `;
  }
}

function edit() {
  location.href = `/quotation-edit.html?id=${id}`;
}

function convert() {
  if (!confirm("Convert this quotation to invoice?")) return;

  fetch("/api/quotation-convert", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  })
  .then(res => {
    if (!res.ok) throw new Error("Failed to convert quotation");
    return res.json();
  })
  .then(data => {
    location.href = `/invoice-view.html?id=${data.invoiceId}`;
  })
  .catch(err => alert(err.message));
}
</script>

</body>
</html>
