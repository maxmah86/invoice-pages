<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Item Catalogs</title>
<meta name="viewport" content="width=device-width, initial-scale=1">

<style>
body {
  font-family: Arial, sans-serif;
  background: #f4f6f8;
  margin: 0;
  padding: 16px;
}

h1 { margin-top: 0; }

.card {
  background: #fff;
  border-radius: 8px;
  padding: 16px;
  margin-bottom: 16px;
  box-shadow: 0 1px 4px rgba(0,0,0,0.08);
}

label {
  display: block;
  font-size: 14px;
  font-weight: bold;
  margin-top: 10px;
}

input, select {
  width: 100%;
  padding: 10px;
  font-size: 14px;
  margin-top: 6px;
}

button {
  padding: 8px 12px;
  font-size: 13px;
  border: none;
  border-radius: 6px;
  cursor: pointer;
}

.btn-save { background: #27ae60; color: #fff; }
.btn-cancel { background: #7f8c8d; color: #fff; }
.btn-edit { background: #2980b9; color: #fff; }
.btn-remove { background: #c0392b; color: #fff; }

.badge {
  padding: 4px 8px;
  border-radius: 4px;
  font-size: 12px;
  font-weight: bold;
}

.badge.active { background: #2ecc71; color: #fff; }
.badge.inactive { background: #c0392b; color: #fff; }

.table {
  width: 100%;
  border-collapse: collapse;
}

.table-wrap {
  width: 100%;
  overflow-x: auto;
}

.table {
  min-width: 700px; /* 关键 */
}

.table th,
.table td {
  border-bottom: 1px solid #eee;
  padding: 10px;
  font-size: 14px;
}
</style>
</head>

<body>

<h1>Item Catalogs</h1>

<!-- ===== FORM ===== -->
<div class="card">
  <h3 id="formTitle">Add New Item</h3>

  <input type="hidden" id="item_id">

  <label>Category</label>
  <input id="category" placeholder="e.g. Labour / Material / Transport">

  <label>Description</label>
  <input id="description">

  <label>Default Amount (RM)</label>
  <input type="number" id="default_amount">

  <label>Status</label>
  <select id="is_active">
    <option value="1">Active</option>
    <option value="0">Inactive</option>
  </select>

  <div style="margin-top:14px;display:flex;gap:8px;">
    <button class="btn-save" onclick="save()">Save</button>
    <button class="btn-cancel" onclick="resetForm()">Cancel</button>
  </div>
</div>

<!-- ===== LIST ===== -->
<div class="card">
  <div style="display:flex; align-items:center; justify-content:space-between;">
    <h3 style="margin:0;">Catalog List</h3>
    <input
      id="filterInput"
      type="text"
      placeholder="Filter description…"
      style="width:200px; padding:8px; font-size:13px;"
      oninput="filterList()"
    >
  </div>

<div class="table-wrap">

  <table class="table">
    <thead>
      <tr>
        <th>Category</th>
        <th>Description</th>
        <th>Default Amount</th>
        <th>Status</th>
        <th>Action</th>
      </tr>
    </thead>
    <tbody id="list">
      <tr><td colspan="5">Loading…</td></tr>
    </tbody>
  </table>
</div>
</div>

<script>
/* ===============================
 * Admin auth
 * =============================== */
fetch("/api/auth-check", { credentials: "include" })
  .then(r => r.json())
  .then(d => {
    if (d.role !== "admin") location.replace("/index.html");
  })
  .catch(() => location.replace("/login.html"));

/* ===============================
 * Global state
 * =============================== */
let catalogData = [];

/* ===============================
 * Load list
 * =============================== */
async function loadList() {
  const res = await fetch("/api/item-catalog-list", { credentials: "include" });
  const data = await res.json();
  catalogData = Array.isArray(data) ? data : [];
  renderList(catalogData);
}
loadList();

/* ===============================
 * Render list
 * =============================== */
function renderList(list) {
  const tbody = document.getElementById("list");
  tbody.innerHTML = "";

  if (!list.length) {
    tbody.innerHTML = `<tr><td colspan="5">No records</td></tr>`;
    return;
  }

  list.forEach(it => {
    const active = Number(it.is_active) === 1;
    const tr = document.createElement("tr");

    tr.innerHTML = `
      <td>${it.category || "-"}</td>
      <td>${it.description}</td>
      <td>RM ${Number(it.default_amount || 0).toFixed(2)}</td>
      <td>
        <span class="badge ${active ? "active" : "inactive"}">
          ${active ? "ACTIVE" : "INACTIVE"}
        </span>
      </td>
      <td>
        <button class="btn-edit" onclick='edit(${JSON.stringify(it)})'>Edit</button>
        <button class="btn-remove" onclick="removeItem(${it.id})">Remove</button>
      </td>
    `;
    tbody.appendChild(tr);
  });
}

/* ===============================
 * Filter
 * =============================== */


function filterList() {
  const keyword = document
    .getElementById("filterInput")
    .value
    .toLowerCase()
    .trim();

  if (!keyword) {
    renderList(catalogData);
    return;
  }

  const filtered = catalogData.filter(it => {
    const desc = (it.description || "").toLowerCase();
    const cat  = (it.category || "").toLowerCase();

    return desc.includes(keyword) || cat.includes(keyword);
  });

  renderList(filtered);
}



/* ===============================
 * Edit
 * =============================== */
function edit(it) {
  document.getElementById("formTitle").textContent = "Edit Item";
  document.getElementById("item_id").value = it.id;
  document.getElementById("category").value = it.category || "";
  document.getElementById("description").value = it.description || "";
  document.getElementById("default_amount").value = it.default_amount || "";
  document.getElementById("is_active").value =
    Number(it.is_active) === 1 ? "1" : "0";
}

/* ===============================
 * Delete
 * =============================== */
async function removeItem(id) {
  if (!confirm("This will permanently delete this item. Continue?")) return;

  const res = await fetch("/api/item-catalog-delete", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ id })
  });

  if (!res.ok) {
    alert("Delete failed");
    return;
  }

  loadList();
}

/* ===============================
 * Reset
 * =============================== */
function resetForm() {
  document.getElementById("formTitle").textContent = "Add New Item";
  document.getElementById("item_id").value = "";
  document.getElementById("category").value = "";
  document.getElementById("description").value = "";
  document.getElementById("default_amount").value = "";
  document.getElementById("is_active").value = "1";
}

/* ===============================
 * Save
 * =============================== */
async function save() {
  const payload = {
    id: document.getElementById("item_id").value || undefined,
    category: document.getElementById("category").value.trim() || null,
    description: document.getElementById("description").value.trim(),
    default_amount: document.getElementById("default_amount").value,
    is_active: document.getElementById("is_active").value === "1"
  };

  if (!payload.description) {
    alert("Description required");
    return;
  }

  const res = await fetch("/api/item-catalog-save", {
    method: "POST",
    credentials: "include",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify(payload)
  });

  if (!res.ok) {
    alert("Save failed");
    return;
  }

  resetForm();
  loadList();
}
</script>

</body>
</html>